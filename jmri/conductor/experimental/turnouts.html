<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Title of the document</title>

<style type="text/css">

body {
    margin: 0;
    background: #000;
}

.svg {
    margin: auto;
    width: 100%;
    height: 100%;
}

</style>

</head>

<body>
<div id="svg_container" class="svg">
</div>
</body>

<!-- script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script -->
<!-- script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.js"></script>


<script src="http://@_JMRI_HOST_@:@_JMRI_WEB_PORT_@/js/jquery-1.11.2.min.js"></script>
<script src="http://@_JMRI_HOST_@:@_JMRI_WEB_PORT_@/js/json2.js"></script>
<script src="http://@_JMRI_HOST_@:@_JMRI_WEB_PORT_@/js/jquery.websocket.js"></script>
<script src="http://@_JMRI_HOST_@:@_JMRI_WEB_PORT_@/js/jquery.jmri.js"></script>
<script>

// Note: for testing this, use Firefox or Chrome Canary with --allow-file-access-from-files
// var svgPath = "../src/test/resources/v2/Conductor Map Mainline 1.svg";

var svgPath = "@_PATH_TO_SVG_@";
var jmriJson = "@_JMRI_HOST_@:@_JMRI_JSON_PORT_@"
var svgDoc;
var jmri;

function setupJmri() {
    var url = "http://" + jmriJson + "/json/";
    jmri = $.JMRI(url, {
        turnout: function (name, state, data) {
            console.log("Got turnout \"" + name + "\" with state " + state + ".");
        },
        console: function(data) { console.log("JMRI: " + data); },
        hello : function() { console.log("JMRI: hello "); },
        goodbye : function() { console.log("JMRI: goodbye "); },
        open: function() { console.log("JMRI: open"); },
        close: function() { console.log("JMRI: close"); },
        didReconnect : function() { console.log("JMRI: didReconnect "); },
        failedReconnect  : function() { console.log("JMRI: failedReconnect  "); }
    })
    jmri.connect();
}

function loadSvg() {
    console.log( "document loaded" );
    svgDoc = SVG("svg_container");
    $.get(svgPath, function(contents) {
        var _tmp = $("svg", contents);
        
        svgDoc.attr('viewBox',  _tmp.attr('viewBox'));
        svgDoc.attr('width',    _tmp.attr('width'));
        svgDoc.attr('height',   _tmp.attr('height'));

        svgDoc.svg(_tmp.html());
        
        console.log( "SVG loaded" );

        var layer = svgDoc.select("#layer1");
        layer.style("display", "inline")

        svgDoc.select('[id^="Toggle-T"]').each(function () {
            setupTurnout(this);
        });
        
    }, "xml");
    setupJmri();
}

function setupTurnout(t) {
    var tid = t.attr("id");
    var jmriName = "N" + tid.substring("Toggle-".length)
    console.log(tid) ;
    t.style("visibility", "visible");
    t.style("opacity", "0");
    t._op = 0;
    t.click(function() {
        console.log( tid + " " + t._op );
        t.animate(125, "<>", 0).style("opacity", "1").animate(125, "<>", 0).style("opacity", "0");
        t._op = 1 - t._op;
        jmri.setTurnout(jmriName, (t._op == 0) ? jmri.CLOSED : jmri.THROWN);
    });
}


$( document ).ready(loadSvg);
</script>

</html>
